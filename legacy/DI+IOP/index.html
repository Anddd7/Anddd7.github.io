<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Anddd7"><title>依赖注入 - 如何使用反射和注解实现简单的依赖注入 · Anddd7's Planet</title><meta name="description" content="Github源码 - &amp;gt; Anddd7/cute-koala
Spring Bean 应该是Spring被使用最多的功能 ,通过注解/xml配置 ,可以简化大量的依赖代码 ,同时也提高了效率 .在试用了Guice和阅读了部分Spring BeanFactory的源码后 ,也了解了一部分依赖注入"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/foundation-icons.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/assets/avatar.jpeg" style="width:127px;"><h3 title=""><a href="/">Anddd7's Planet</a></h3><div class="description"><p>Level Up! Programmer~</p></div></div></div><ul class="social-links"><li><a href="http://github.com/Anddd7"><i class="fa fa-github"></i></a></li><li><a href="mailto:liaoad_space@sina.com"><i class="fi-mail"></i></a></li></ul><div class="footer"><span>Theme based on </span><a href="https://github.com/Ben02/hexo-theme-Anatole"> <strong>Anatole</strong></a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/assets/avatar.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>依赖注入 - 如何使用反射和注解实现简单的依赖注入</a></h3></div><div class="post-content"><p>Github源码 - &gt; <a href="https://github.com/Anddd7/cute-koala" target="_blank" rel="noopener">Anddd7/cute-koala</a></p>
<p>Spring Bean 应该是Spring被使用最多的功能 ,通过注解/xml配置 ,可以简化大量的依赖代码 ,同时也提高了效率 .在试用了Guice和阅读了部分Spring BeanFactory的源码后 ,也了解了一部分依赖注入的原理 ,自己写了一个小框架来印证一下.</p>
<h2 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h2><p>依赖注入 ,也就是所依赖的对象不由自己处理 ,而是由外部系统去分配 .就像排队取餐时 ,不是每个人自己去盛菜 ,而是告诉服务员自己需要什么 ,由服务员准备好给你 .</p>
<p>这样的好处在于 ,我们不再需要 ‘盛菜’(new) 这个动作 ,只需要告诉 ‘服务员’(DI 容器) 我需要 ‘菜’(依赖的对象) 就可以了 . <br><br>对于很多情况下 ,需要的还可能是 ‘扳手’ 这样可复用的工具 ,那么我们就可以避免大量的new动作 ,节省很多对象资源 .</p>
<h2 id="如何注入"><a href="#如何注入" class="headerlink" title="如何注入"></a>如何注入</h2><p>当我们需要使用某个对象时 ,我们会把它引入到类中 :</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">A</span>&#123;</span><br><span class="line">    B <span class="keyword">object</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">method</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">object</span>.<span class="keyword">do</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接运行的话 ,object是null ,程序异常 .我们需要在执行method方法前把B的实例(instance)放到object这个位置 .</p>
<ul>
<li>constructor - 通过A的构造器传入 - [必须在A初始化前初始化B]</li>
<li>set - 设置一个set方法 - [需要显式的调用set/使用反射调用set…]</li>
<li>setField - 反射直接设置属性值</li>
</ul>
<p>constructor方式需要分析对象依赖的顺序 ,如果有环 ,那么就会死锁 ; set方法和对象的实例化是分离的 ,如果所依赖的对象还没有实例 ,就等待它实例化后再set到需要的类中 ;后两种都是Spring使用过的方法 ,都是使用反射 ;setField不需要生成set方法 ,代码看起来会清洁一点 .</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629165431612?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTg1ODQwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""></p>
<p>如上图 ,按照配置文件顺序加载 ,如果依赖对象未存在则等待 ,依赖对象实例化后立即回填这个依赖 .</p>
<h1 id="Cute-Koala"><a href="#Cute-Koala" class="headerlink" title="Cute Koala"></a>Cute Koala</h1><p>首先 ,为这个框架取了一个可爱的名字 Github - <a href="https://github.com/Anddd7/cute-koala" target="_blank" rel="noopener">Cute Cute Koala</a> ,然后按照上图的流程进行设计.</p>
<hr>
<h3 id="配置文件-使用注解来标识Bean"><a href="#配置文件-使用注解来标识Bean" class="headerlink" title="配置文件 - 使用注解来标识Bean"></a>配置文件 - 使用注解来标识Bean</h3><p>使用@Module标识的<code>UserModule.class</code>其实就相当于一个配置文件 ,本身没有实际的作用 ,注解看起来更加整洁一些.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span> <span class="comment">//标识这是一个模块 ,不同模块的bean互相独立 </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Koala</span> <span class="comment">//标识Bean的注解</span></span><br><span class="line">  HttpService httpService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Koala(UserServiceImpl.class)</span> <span class="comment">//如果Bean是一个接口 ,可以指定其实现 ;同一module内不允许设置不同的实现</span></span><br><span class="line">  UserService userService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Koala(scope = ScopeEnum.NOSCOPE)</span> <span class="comment">//Bean是非单例的</span></span><br><span class="line">  RandomTool randomTool;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong>@Koala注解用来标识Bean的实现(如果声明是Interface) 和 是否单例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public @interface Koala &#123;</span><br><span class="line">  Class&lt;?&gt; value()<span class="built_in"> default </span>Koala.class;</span><br><span class="line">  ScopeEnum scope()<span class="built_in"> default </span>ScopeEnum.SINGLETON;</span><br><span class="line">  enum ScopeEnum &#123;</span><br><span class="line">    SINGLETON, NOSCOPE</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过读取@Module注解的class文件 ,就可以分析出里面所有的Bean</p>
<h3 id="衍生问题"><a href="#衍生问题" class="headerlink" title="衍生问题"></a>衍生问题</h3><li>嵌套依赖 <br><br>依赖关系一般是多层相互交错的 ,Bean可能依赖另一个Bean ,分析Module Class只是将最表一层的Bean加载到了容器中 ,但他们里面还会有依赖关系的存在 . 如下 ,UserService (实现为UserServiceImpl ) 里面还依赖了其他Bean ,因此我们在扫描Bean的时候需要递归扫描 .</li>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> &#123;</span></span><br><span class="line">  <span class="meta">@Koala</span>(UserDaoImpl.<span class="keyword">class</span>)</span><br><span class="line">  UserDao userDao;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Koala</span>(scope = ScopeEnum.NOSCOPE)</span><br><span class="line">  RandomTool randomTool;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> welcome() &#123;</span><br><span class="line">    System.out.println(<span class="string">"Welcome,"</span> + userDao.getName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> 扫描@Module中的@Koala标记 ,注册到当前@Module的Bean容器中 ;扫描Bean中还有没有@Koala标记 .</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">class</span> ModuleScanner &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 扫描</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  private void scanModule(KoalaModule <span class="keyword">beanModule) </span>&#123;</span><br><span class="line">    log.info(<span class="string">"开始扫描模块:&#123;&#125;"</span>, <span class="keyword">beanModule.getModuleName());</span></span><br><span class="line"><span class="keyword"> </span>   scanClass(<span class="keyword">beanModule, </span><span class="keyword">beanModule.moduleClass);</span></span><br><span class="line"><span class="keyword"> </span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 扫描类 ,方便树型操作</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  private void scanClass(KoalaModule <span class="keyword">beanModule, </span>Class moduleClass) &#123;</span><br><span class="line">    log.info(<span class="string">"开始扫描目标类[&#123;&#125;],路径[&#123;&#125;]"</span>, moduleClass.getSimpleName(), moduleClass.getName())<span class="comment">;</span></span><br><span class="line">    Arrays.asList(moduleClass.getDeclaredFields())</span><br><span class="line">        .forEach(<span class="meta">field</span> -&gt; scanComponent(<span class="keyword">beanModule, </span><span class="meta">field</span>))<span class="comment">;</span></span><br><span class="line">    log.info(<span class="string">"扫描类[&#123;&#125;]完毕"</span>, moduleClass.getSimpleName())<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 扫描需要注入依赖的字段</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  private void scanComponent(KoalaModule <span class="keyword">beanModule, </span><span class="meta">Field</span> <span class="meta">field</span>) &#123;</span><br><span class="line">    <span class="meta">if</span> (Objects.isNull(<span class="meta">field</span>.getAnnotation(Koala.class))) &#123;</span><br><span class="line">      return<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class defineType = <span class="meta">field</span>.getType()<span class="comment">;</span></span><br><span class="line">    Class implementType = <span class="meta">field</span>.getAnnotation(Koala.class).value()<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (implementType.equals(Koala.class)) &#123;</span><br><span class="line">      implementType = defineType<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Boolean </span>isSingleton = <span class="meta">field</span>.getAnnotation(Koala.class).scope().equals(ScopeEnum.SINGLETON)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"扫描Bean,声明类型[&#123;&#125;] ,实现类型[&#123;&#125;],是否单例[&#123;&#125;]"</span>, defineType.getName(), implementType.getName(),</span><br><span class="line">        isSingleton)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">beanModule.createBean(defineType, </span>implementType, isSingleton)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    //递归扫描子模块</span><br><span class="line">    log.info(<span class="string">"开始扫描[&#123;&#125;]字段的依赖类[&#123;&#125;]"</span>, <span class="meta">field</span>.getName(), implementType.getSimpleName())<span class="comment">;</span></span><br><span class="line">    scanClass(<span class="keyword">beanModule, </span>implementType)<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建Module"><a href="#创建Module" class="headerlink" title="创建Module"></a>创建Module</h3><p><strong>框架代码:</strong> 通过@Module进行配置 ,然后交给框架的中心控制器<code>KoalaFactory</code>进行扫描 ,就会按照配置生成相应KoalaModule类 ,里面包含Bean容器 ,扫描到的Bean就会进行实例化放入Bean容器 .</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> KoalaFactory &#123;</span><br><span class="line"></span><br><span class="line">  @Getter</span><br><span class="line">  <span class="keyword">private</span> List&lt;<span class="keyword">Class</span>&gt; moduleList;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Map&lt;<span class="keyword">Class</span>, KoalaModule&gt; moduleMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> ModuleScanner scanner = <span class="keyword">new</span> ModuleScanner();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//可以切换当前module</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">  <span class="keyword">private</span> KoalaModule currentModule;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> KoalaFactory of(<span class="keyword">Class</span>... modules) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KoalaFactory().build(modules);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构建</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> KoalaFactory build(<span class="keyword">Class</span>... moduleClasses) &#123;</span><br><span class="line">    moduleList = Arrays.<span class="keyword">asList</span>(moduleClasses);</span><br><span class="line">    scanAndBuild(moduleClasses);</span><br><span class="line">    first();<span class="comment">//设置第一个注册module为当前使用的module</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 扫描器扫描并生成 module ,默认设置第一个module为当前的操作module</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> scanAndBuild(<span class="keyword">Class</span>... moduleClasses) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">Class</span> moduleClass : moduleClasses) &#123;</span><br><span class="line">      scanner.createModule(moduleClass)<span class="comment">//扫描module</span></span><br><span class="line">          .ifPresent(beanModule -&gt; moduleMap.put(moduleClass, beanModule));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注册实例Bean"><a href="#注册实例Bean" class="headerlink" title="注册实例Bean"></a>注册实例Bean</h3><p><strong>框架代码:</strong> 扫描器在扫描到KoalaModule中符合要求的Bean时 ,就会告知KoalaModule注册这个Bean到容器中.</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModuleScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建一个module</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Optional&lt;KoalaModule&gt; createModule(Class moduleClass) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isModule(moduleClass)) &#123;</span><br><span class="line">      <span class="keyword">return</span> Optional.empty();</span><br><span class="line">    &#125;</span><br><span class="line">    KoalaModule <span class="keyword">new</span><span class="type">Module</span> = <span class="keyword">new</span> <span class="type">KoalaModule</span>(moduleClass);</span><br><span class="line">    scanModule(<span class="keyword">new</span><span class="type">Module</span>);</span><br><span class="line">    <span class="keyword">return</span> Optional.of(<span class="keyword">new</span><span class="type">Module</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 检查注解标记</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> Boolean isModule(Class moduleClass) &#123;</span><br><span class="line">    <span class="keyword">return</span> !Objects.isNull(moduleClass.getAnnotationsByType(Module.class));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//本段代码在前面有</span></span><br><span class="line">  <span class="keyword">private</span> void scanComponent(KoalaModule beanModule, Field field) &#123;</span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line">    log.info(<span class="string">"扫描Bean,声明类型[&#123;&#125;] ,实现类型[&#123;&#125;],是否单例[&#123;&#125;]"</span>,</span><br><span class="line">        defineType.getName(), implementType.getName(),isSingleton);</span><br><span class="line"></span><br><span class="line">    beanModule.createBean(defineType, implementType, isSingleton);</span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> KoalaModule会创建一个BeanPool ,由这个缓冲池来管理Bean的存取和依赖关系的解决</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">beanPool.addBean(defineType, </span>implementType, isSingleton)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> 使用BeanWrapper包装Bean的Class/instance/是否单例等信息 .</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class BeanWrapper &#123;</span><br><span class="line"> <span class="keyword"> private</span> Class defineType;//声明类型</span><br><span class="line"> <span class="keyword"> private</span> Class implementType;//实例类型</span><br><span class="line"> <span class="keyword"> private</span> Object instance;//实例对象</span><br><span class="line"> <span class="keyword"> private</span> Boolean singleton;</span><br><span class="line"></span><br><span class="line"> <span class="keyword"> public</span><span class="keyword"> static</span> BeanWrapper of(Class classType, Class implementType, Boolean isSingleton) &#123;</span><br><span class="line">    //new + set</span><br><span class="line">   <span class="built_in"> return </span>beanWrapper;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * 根据Bean的条件 创建instance</span><br><span class="line">   * - 单例直接生成对象</span><br><span class="line">   * - 非单例存放class ,在getBean时再实例化</span><br><span class="line">   * - 代理对象(Http RPC ,后续说明)</span><br><span class="line">   */</span><br><span class="line">  void initInstance() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">     <span class="built_in"> if </span>(!singleton) &#123;</span><br><span class="line">        //非单例 ,object存放实现类型 ,getBean时自动实例化</span><br><span class="line">       <span class="built_in"> instance </span>= implementType;</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      //单例的代理接口 ,生成代理对象</span><br><span class="line">     <span class="built_in"> if </span>(!Objects.isNull(defineType.getAnnotation(HttpKoala.class))) &#123;</span><br><span class="line">       <span class="built_in"> instance </span>= HttpProxyBeanFactory.getProxyInstance(defineType);</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      //单例的Class 或 接口 ,实现类直接实例化</span><br><span class="line">     <span class="built_in"> instance </span>= implementType.newInstance();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      log.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> 如果不存在Bean ,则注册Bean放入缓冲池 ;然后检查Bean的依赖关系.</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> void <span class="keyword">addBean(Class </span>defineType, Class implementType, <span class="keyword">Boolean </span>isSingleton) &#123;</span><br><span class="line">    <span class="keyword">BeanWrapper </span><span class="keyword">beanWrapper </span>= <span class="keyword">beanCache.get(defineType);</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (Objects.isNull(<span class="keyword">beanWrapper)) </span>&#123;</span><br><span class="line">      //创建新的<span class="keyword">bean放入cache</span></span><br><span class="line"><span class="keyword"> </span>     <span class="keyword">beanWrapper </span>= <span class="keyword">BeanWrapper.of(defineType, </span>implementType, isSingleton)<span class="comment">;</span></span><br><span class="line">      <span class="keyword">beanCache.put(beanWrapper);</span></span><br><span class="line"><span class="keyword"> </span>   &#125; <span class="meta">else</span> &#123;</span><br><span class="line">      <span class="keyword">beanWrapper.checkConflict(implementType, </span>isSingleton)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">if</span> (<span class="keyword">beanWrapper.getSingleton()) </span>&#123;</span><br><span class="line">      //检查自身是否依赖其他<span class="keyword">bean</span></span><br><span class="line"><span class="keyword"> </span>     checkRelyFrom(<span class="keyword">beanWrapper, </span>this::waitOrResolveRely)<span class="comment">;</span></span><br><span class="line">    &#125; <span class="meta">else</span> &#123;</span><br><span class="line">      log.info(<span class="string">"非单例Bean ,获取Bean时再解决依赖"</span>)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    //检查自身是否被其他类依赖</span><br><span class="line">    checkRelyTo(<span class="keyword">beanWrapper);</span></span><br><span class="line"><span class="keyword"> </span> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="衍生问题-1"><a href="#衍生问题-1" class="headerlink" title="衍生问题"></a>衍生问题</h3><ul>
<li>依赖解决 ,在BeanPool中设置了2个缓存Map ,一个是放置BeanWrapper的Bean容器 ;一个是依赖关系的管理器 .</li>
</ul>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BeanWrapperCache beanCache = <span class="keyword">new</span> BeanWrapperCache();</span><br><span class="line">//<span class="keyword">private</span> Map&lt;<span class="class"><span class="keyword">Class</span>, <span class="title">BeanWrapper</span>&gt; - <span class="title">Class</span>:注册的<span class="title">Bean</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BeanRelyCache relyCache = <span class="keyword">new</span> BeanRelyCache();</span><br><span class="line">//<span class="keyword">private</span> ListMultimap&lt;<span class="class"><span class="keyword">Class</span>, <span class="title">BeanWrapper</span>&gt; - <span class="title">Class</span>:<span class="title">List</span>&lt;需要<span class="title">Class</span>实例的其他<span class="title">Bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> 检查是否依赖其他对象 -&gt; 内部有没有@Koala标记的Field ; 处理依赖 (有则set/无则等待)</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> class <span class="keyword">BeanPool </span>&#123;</span><br><span class="line">  private void checkRelyFrom(<span class="keyword">BeanWrapper </span><span class="keyword">beanWrapper,</span></span><br><span class="line"><span class="keyword"> </span>     <span class="keyword">BiConsumer&lt;BeanWrapper, </span><span class="meta">Field</span>&gt; <span class="keyword">biConsumer) </span>&#123;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"[&#123;&#125;]正在加载 ,检查是否依赖其他对象"</span>, <span class="keyword">beanWrapper.getImplementType().getName());</span></span><br><span class="line"><span class="keyword"> </span>   //查看其实现类(也就是对应的实例对象)中是否依赖其他<span class="keyword">Bean</span></span><br><span class="line"><span class="keyword"> </span>   Arrays.asList(<span class="keyword">beanWrapper.getImplementType().getDeclaredFields()).forEach(field </span>-&gt; &#123;</span><br><span class="line">      <span class="meta">if</span> (!Objects.isNull(<span class="meta">field</span>.getAnnotation(Koala.class))) &#123;</span><br><span class="line">        <span class="keyword">biConsumer.accept(beanWrapper, </span><span class="meta">field</span>)<span class="comment">;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> private void waitOrResolveRely(<span class="keyword">BeanWrapper </span><span class="keyword">beanWrapper, </span><span class="meta">Field</span> <span class="meta">field</span>) &#123;</span><br><span class="line">    //获取依赖的<span class="keyword">Bean的实现类型(对应对象的类型)</span></span><br><span class="line"><span class="keyword"> </span>   Class implementType = <span class="meta">field</span>.getAnnotation(Koala.class).value()<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (implementType.equals(Koala.class)) &#123;</span><br><span class="line">      implementType = <span class="meta">field</span>.getType()<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //查看实例是否已存在</span><br><span class="line">    <span class="keyword">BeanWrapper </span>oldBeanWrapper = <span class="keyword">beanCache.get(implementType);</span></span><br><span class="line"><span class="keyword"> </span>   //检查依赖<span class="keyword">Bean是否已加载 </span>,未加载则等待加载</span><br><span class="line">    <span class="meta">if</span> (Objects.isNull(oldBeanWrapper)) &#123;</span><br><span class="line">      //放入关系池 等待依赖对象</span><br><span class="line">      relyCache.put(implementType, <span class="keyword">beanWrapper);</span></span><br><span class="line"><span class="keyword"> </span>   &#125; <span class="meta">else</span> &#123;</span><br><span class="line">      //发现依赖对象set到自身(非单例缓存的是class ,需要在<span class="meta">get</span>的时候再set)</span><br><span class="line">      <span class="meta">if</span> (<span class="keyword">beanWrapper.getSingleton()) </span>&#123;</span><br><span class="line">        resolveRely(<span class="keyword">beanWrapper.getInstance(), </span><span class="meta">field</span>, oldBeanWrapper.getInstance())<span class="comment">;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private void resolveRely(Object parent, <span class="meta">Field</span> <span class="meta">field</span>, Object instance) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      log.info(<span class="string">"!!!\t\t处理依赖:[&#123;&#125;]已加载到[&#123;&#125;]的[&#123;&#125;]字段中."</span>, instance.getClass().getSimpleName(),</span><br><span class="line">          parent.getClass().getName(), <span class="meta">field</span>.getName())<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">      <span class="meta">field</span>.setAccessible(true)<span class="comment">;</span></span><br><span class="line">      <span class="meta">field</span><span class="meta">.set</span>(parent, instance)<span class="comment">;</span></span><br><span class="line">    &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">      log.error(e.getMessage(), e)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> 检查是否被其他对象依赖 -&gt; 依赖关系中有没有依赖列表</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取到 #classType 类型的对象 ,开始检索依赖关系并set到对应位置</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  private void checkRelyTo(<span class="keyword">BeanWrapper </span><span class="keyword">beanWrapper) </span>&#123;</span><br><span class="line">    log.info(<span class="string">"[&#123;&#125;-&#123;&#125;]正在加载,检查是否被其他对象依赖"</span>, <span class="keyword">beanWrapper.getDefineType(),</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">beanWrapper.getImplementType().getName());</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   //检查自身的实现类型是否被其他类需要</span><br><span class="line">    relyCache.get(<span class="keyword">beanWrapper.getImplementType())</span></span><br><span class="line"><span class="keyword"> </span>       .forEach(parentBeanWrapper -&gt; &#123;</span><br><span class="line">          Object parent = parentBeanWrapper.getInstance()<span class="comment">;</span></span><br><span class="line">          //获取parent中属于<span class="keyword">bean </span>(class一致) 的<span class="meta">field</span> ,把<span class="keyword">bean的instanceset进去</span></span><br><span class="line"><span class="keyword"> </span>         CollectionTool.dealFirst(//获取列表的第一个符合要求的元素</span><br><span class="line">              parent.getClass().getDeclaredFields(),</span><br><span class="line"><span class="symbol">              beanWrapper:</span>:matchType,//<span class="meta">field</span>的类型与<span class="keyword">bean一致</span></span><br><span class="line"><span class="keyword"> </span>             t -&gt; resolveRely(parent, t, <span class="keyword">beanWrapper.getObjectOfInstance())//resolveRely见上一段代码</span></span><br><span class="line"><span class="keyword"> </span>         )<span class="comment">;</span></span><br><span class="line">        &#125;)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    relyCache.remove(<span class="keyword">beanWrapper.getImplementType());</span></span><br><span class="line"><span class="keyword"> </span> &#125;</span><br></pre></td></tr></table></figure>
<p><strong>逻辑就和最开始的图上展现的一样 ,有则加载无则等待 ;加载的Bean发现被别人依赖 ,会主动set到需要的地方 .</strong></p>
<h3 id="获取Bean"><a href="#获取Bean" class="headerlink" title="获取Bean"></a>获取Bean</h3><p><strong>框架代码:</strong> 单例的Bean在注册时已经实例化 ,所以直接取instance即可 ;非单例的需要现场newInstance ,如果他依赖了其他单例的Bean ,再现场set一下 ,这样就可以得到符合要求的非单例Bean了 .</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> BeanPool &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> BeanWrapperCache beanCache = <span class="keyword">new</span> BeanWrapperCache();</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> BeanRelyCache relyCache = <span class="keyword">new</span> BeanRelyCache();</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取对应类型的Bean对象</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> &lt;T&gt; T getBean(Class&lt;T&gt; classType) &#123;</span><br><span class="line">   BeanWrapper <span class="keyword">scope</span> = beanCache.get(classType);</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">scope</span>.getSingleton()) &#123;</span><br><span class="line">     log.info(<span class="string">"当前Bean是单例,直接返回缓冲池中的对象."</span>);</span><br><span class="line">     <span class="keyword">return</span> (T) <span class="keyword">scope</span>.getInstance();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     log.info(<span class="string">"当前Bean是非单例的,创建新的对象."</span>);</span><br><span class="line">     <span class="comment">//如果是远程代理的Bean ,直接生成远程代理</span></span><br><span class="line">     <span class="keyword">if</span> (classType.isInterface() &amp;amp;&amp;amp; !Objects.isNull(classType.getAnnotation(HttpKoala.<span class="keyword">class</span>))) &#123;</span><br><span class="line">       <span class="keyword">return</span> (T) HttpProxyBeanFactory.getProxyInstance(classType);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     T instance = ((Class&lt;T&gt;) <span class="keyword">scope</span>.getInstance()).newInstance();</span><br><span class="line">     <span class="comment">//创建对象时查看内部是否有依赖关系 ,有则set到instance里</span></span><br><span class="line">     checkRelyFrom(<span class="keyword">scope</span>, (beanWrapper, field) -&gt;</span><br><span class="line">         resolveRely(instance, field, getBean(field.getType()))</span><br><span class="line">     );</span><br><span class="line">     <span class="keyword">return</span> instance;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">     log.error(e.getMessage(), e);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><strong><em> 一个DI工具就基本成型了 ,测试打印一下 ,嵌套的Bean和容器的快照对比 ,都是正确的 ;单例对象一致 ,非单例为不同对象</em></strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">KoalaFactory beanFactory</span> = KoalaFactory.of(UserModule.class);</span><br><span class="line"><span class="attribute">HttpService httpService</span> = beanFactory.getBean(HttpService.class);</span><br><span class="line"><span class="attribute">UserService userService</span> = beanFactory.getBean(UserService.class);</span><br><span class="line"><span class="attribute">RandomTool randomTool</span> = beanFactory.getBean(RandomTool.class);</span><br></pre></td></tr></table></figure>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">通过Factory.getBean</span><br><span class="line"><span class="keyword">com</span>.koala.services.impl.UserServiceImpl |   <span class="keyword">com</span>.koala.services.impl.UserServiceImpl<span class="subst">@16267862</span></span><br><span class="line"><span class="keyword">com</span>.koala.services.impl.UserServiceImpl |   <span class="keyword">com</span>.koala.services.impl.UserServiceImpl<span class="subst">@16267862</span></span><br><span class="line"><span class="keyword">com</span>.koala.daos.impl.UserDaoImpl |   <span class="keyword">com</span>.koala.daos.impl.UserDaoImpl<span class="subst">@453</span>da22c</span><br><span class="line"><span class="keyword">com</span>.koala.daos.impl.UserDaoImpl |   <span class="keyword">com</span>.koala.daos.impl.UserDaoImpl<span class="subst">@453</span>da22c</span><br><span class="line"><span class="keyword">com</span>.koala.daos.impl.UserDaoImpl |   <span class="keyword">com</span>.koala.daos.impl.UserDaoImpl<span class="subst">@453</span>da22c</span><br><span class="line"><span class="keyword">com</span>.koala.webservice.HttpService$$EnhancerByCGLIB$$<span class="number">9</span>c1900a1   |   github.koala.webservice.resetful.HttpProxyObject<span class="subst">@71248</span>c21</span><br><span class="line"><span class="keyword">com</span>.koala.utils.RandomTool  |   <span class="keyword">com</span>.koala.utils.RandomTool<span class="subst">@442675</span>e1</span><br><span class="line"><span class="keyword">com</span>.koala.utils.RandomTool  |   <span class="keyword">com</span>.koala.utils.RandomTool<span class="subst">@6166</span>e06f</span><br><span class="line">容器:</span><br><span class="line"><span class="keyword">com</span>.koala.utils.RandomTool  |   class <span class="keyword">com</span>.koala.utils.RandomTool</span><br><span class="line"><span class="keyword">com</span>.koala.services.impl.UserServiceImpl |   <span class="keyword">com</span>.koala.services.impl.UserServiceImpl<span class="subst">@16267862</span></span><br><span class="line"><span class="keyword">com</span>.koala.daos.UserDao  |   <span class="keyword">com</span>.koala.daos.impl.UserDaoImpl<span class="subst">@453</span>da22c</span><br><span class="line"><span class="keyword">com</span>.koala.services.UserService  |   <span class="keyword">com</span>.koala.services.impl.UserServiceImpl<span class="subst">@16267862</span></span><br><span class="line"><span class="keyword">com</span>.koala.webservice.HttpService    |   github.koala.webservice.resetful.HttpProxyObject<span class="subst">@71248</span>c21</span><br><span class="line"><span class="keyword">com</span>.koala.daos.impl.UserDaoImpl |   <span class="keyword">com</span>.koala.daos.impl.UserDaoImpl<span class="subst">@453</span>da22c</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h2><ul>
<li>模板生成 : 娱乐功能 ,读取yaml配置 生成对应的 Module.java文件</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">modules:</span><br><span class="line">- moduleName: user-http</span><br><span class="line">  packageName: com.koala</span><br><span class="line">  beans:</span><br><span class="line">  - beanName: httpService</span><br><span class="line">    path: com<span class="selector-class">.koala</span><span class="selector-class">.services</span><span class="selector-class">.HttpService</span></span><br><span class="line"></span><br><span class="line">  - beanName: userService</span><br><span class="line">    path: com<span class="selector-class">.koala</span><span class="selector-class">.services</span><span class="selector-class">.UserService</span></span><br><span class="line">    implPath: com<span class="selector-class">.koala</span><span class="selector-class">.services</span><span class="selector-class">.impl</span><span class="selector-class">.UserServiceImpl</span></span><br><span class="line"></span><br><span class="line">  - beanName: randomTool</span><br><span class="line">    path: com<span class="selector-class">.koala</span><span class="selector-class">.utils</span><span class="selector-class">.RandomTool</span></span><br><span class="line">    scope: no</span><br></pre></td></tr></table></figure>
<p><strong>To</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">github</span>.<span class="keyword">koala</span>.<span class="keyword">core</span>.<span class="keyword">annotation</span>.<span class="keyword">Module</span></span><br><span class="line"><span class="keyword">public</span> class UserHttpModule &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">github</span>.<span class="keyword">koala</span>.<span class="keyword">core</span>.<span class="keyword">annotation</span>.<span class="keyword">Koala</span></span><br><span class="line">  HttpService httpService;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">github</span>.<span class="keyword">koala</span>.<span class="keyword">core</span>.<span class="keyword">annotation</span>.<span class="keyword">Koala</span>(<span class="keyword">value</span> = com.koala.services.impl.UserServiceImpl.class)</span><br><span class="line">    com.koala.services.UserService userService;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">github</span>.<span class="keyword">koala</span>.<span class="keyword">core</span>.<span class="keyword">annotation</span>.<span class="keyword">Koala</span>(<span class="keyword">scope</span> = github.koala.core.annotation.Koala.ScopeEnum.NOSCOPE)</span><br><span class="line">    com.koala.utils.RandomTool randomTool;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Http RPC : 对Restful的Http服务做了一个代理</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@HttpKoala</span>(<span class="string">"http://localhost:9999/api"</span>)</span><br><span class="line">public interface HttpService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">@HttpKoalaMethod</span>( <span class="string">"/user"</span>)</span><br><span class="line">  User getUser(<span class="variable">@HttpKoalaParameter</span>(<span class="string">"name"</span>) String name);</span><br><span class="line"></span><br><span class="line">  <span class="variable">@HttpKoalaMethod</span>( <span class="string">"/users"</span>)</span><br><span class="line">  User[] getUsers(<span class="variable">@HttpKoalaParameter</span>(<span class="string">"names"</span>) String... names);</span><br><span class="line"></span><br><span class="line">  <span class="variable">@HttpKoalaMethod</span>(value = <span class="string">"/userList"</span>, httpMethod = HttpMethod.POST)</span><br><span class="line">  List&lt;User&gt; getUserList(<span class="variable">@HttpKoalaParameter</span>(<span class="string">"names"</span>) List&lt;String&gt; names);</span><br><span class="line"></span><br><span class="line">  <span class="variable">@HttpKoalaMethod</span>(<span class="string">"/userMap"</span>)</span><br><span class="line">  Map&lt;String, User&gt; getUserMap(<span class="variable">@HttpKoalaParameter</span>(<span class="string">"name"</span>) String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> 通过<code>@HttpKoala/@HttpKoalaMethod/@HttpKoalaParameter</code>来确定调用的Http URL和方法 ,使用cglib生成了一个代理对象 ,把方法代理成Http调用 .</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HttpProxyObject</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   * 代理方法 ,托管给http完成</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   *</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   * @param o 当前的对象</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   * @param method 调用的目标方法</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   * @param args 方法参数</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   * @param methodProxy cglib派生的子对象</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   */</span></span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  public <span class="built_in">Object</span> intercept(<span class="built_in">Object</span> o, Method method, <span class="built_in">Object</span>[] args, MethodProxy methodProxy)</span><br><span class="line">      throws Throwable &#123;</span><br><span class="line">    Instant start = Instant.now();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//屏蔽toString ,equals等方法</span></span><br><span class="line">    <span class="built_in">Object</span> parentMethodResult = checkProxyMethod(method, args);</span><br><span class="line">    <span class="keyword">if</span> (parentMethodResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parentMethodResult;</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"----------------------------------------------"</span>);</span><br><span class="line">    log.info(<span class="string">"[&#123;&#125;]调用远程方法[&#123;&#125;]."</span>, className, method.getName());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">String</span> url = rootUrl + method.getAnnotation(HttpKoalaMethod.<span class="keyword">class</span>).value();</span><br><span class="line">    HttpMethod httpMethod = method.getAnnotation(HttpKoalaMethod.<span class="keyword">class</span>).httpMethod();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建请求request</span></span><br><span class="line">    Request request;</span><br><span class="line">    <span class="keyword">if</span> (httpMethod.equals(HttpMethod.GET)) &#123;</span><br><span class="line">      request = httpClient.initGet(url + requestParser.formatParameter2Url(method, args));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      request = httpClient.initPost(url, requestParser.getMediaType(),</span><br><span class="line">          requestParser.formatParameter2Body(method, args));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//一个切面 可以检查request</span></span><br><span class="line">    requestParser.checkRequest(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行</span></span><br><span class="line">    Response response = httpClient.execute(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析</span></span><br><span class="line">    <span class="built_in">Object</span> result = responseParser.parserResponse(response, method.getReturnType());</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"[&#123;&#125;]远程方法[&#123;&#125;]代理执行时间:[&#123;&#125;]"</span>, className, method.getName(),</span><br><span class="line">        <span class="built_in">Duration</span>.between(start, Instant.now()).toMillis());</span><br><span class="line">    log.info(<span class="string">"----------------------------------------------\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> Http的请求消息和响应消息都做了一个可替换的parser ,默认是JSON ,只要实现对应的接口 ,在@HttpKoala中设置就可以替换了.</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public @interface HttpKoala &#123;</span><br><span class="line">  String value();</span><br><span class="line">  Class responseParser()<span class="built_in"> default </span>JsonResponseParser.class;</span><br><span class="line">  Class requestParser()<span class="built_in"> default </span>JsonRequestParser.class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>框架代码:</strong> HttpClientPool 是封装的OkHttp ,对外没有依赖 ,比较简洁也很好修改 ; </p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpProxyObject</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">MethodInterceptor</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">String</span> className;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">String</span> rootUrl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> AbstractResponseParser responseParser;</span><br><span class="line">  <span class="keyword">private</span> AbstractRequestParser requestParser;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> HttpClientPool httpClient = <span class="keyword">new</span> <span class="type">HttpClientPool</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建代理对象 ,添加序列化工具</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  HttpProxyObject(Class&lt;?&gt; classType) &#123;</span><br><span class="line">    <span class="built_in">this</span>.className = classType.getName();</span><br><span class="line">    <span class="built_in">this</span>.rootUrl = classType.getAnnotation(HttpKoala.class).value();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查解析器</span></span><br><span class="line">    Class&lt;?&gt; resParserClass = classType.getAnnotation(HttpKoala.class).responseParser();</span><br><span class="line">    Class&lt;?&gt; reqParserClass = classType.getAnnotation(HttpKoala.class).requestParser();</span><br><span class="line">    <span class="keyword">if</span> (resParserClass.isAssignableFrom(AbstractResponseParser.class) &amp;amp;&amp;amp; reqParserClass</span><br><span class="line">        .isAssignableFrom(AbstractRequestParser.class)) &#123;</span><br><span class="line">      log.error(<span class="string">"对应的消息解析器必须继承自AbstractResponseParser和AbstractRequestParser."</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      responseParser = (AbstractResponseParser) resParserClass.<span class="keyword">new</span><span class="type">Instance</span>();</span><br><span class="line">      requestParser = (AbstractRequestParser) reqParserClass.<span class="keyword">new</span><span class="type">Instance</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"生成[&#123;&#125;]远程代理Bean,使用[&#123;&#125;]进行结果解析"</span>, classType.getName(), resParserClass.getName());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>代码还是要多写才行</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-06-29</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://anddd7.github.io/legacy/DI+IOP/,Anddd7's Planet,依赖注入 - 如何使用反射和注解实现简单的依赖注入,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/legacy/Spring AOP/" title="Spring AOP造成的@Controller注册失败">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/legacy/Panning/" title="最近计划">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>