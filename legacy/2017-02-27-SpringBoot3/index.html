<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        SpringBoot学习-第三章 Spring高级应用-[Spring Boot 实战] - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/assets/avatar.jpeg" />
        </div>
        <div class="name">
            <i>Anddd7</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Aware"><span class="toc-text">Spring Aware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多线程"><span class="toc-text">多线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#计划任务"><span class="toc-text">计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条件注解"><span class="toc-text">条件注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#组合注解和元注解"><span class="toc-text">组合注解和元注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Enable-注解的原理"><span class="toc-text">@Enable*注解的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        SpringBoot学习-第三章 Spring高级应用-[Spring Boot 实战]
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-01-06 21:20:16</span></span>
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="Spring-Aware"><a href="#Spring-Aware" class="headerlink" title="Spring Aware"></a>Spring Aware</h2><p>通常@Component标识的Bean由容器所管理，但它自身是不能和容器交互的（解耦），你只能通过@Autowired引入并使用。而Aware接口为Bean提供了与容器交互的能力。</p>
<ul>
<li>BeanNameAware：获取容器中Bean的名称</li>
<li>BeanFactoryAware：获取当前Bean的Factory，从而调用容器的服务</li>
<li>MessagerSourceAware：获取文本信息</li>
<li>ApplicationEventPublisherAware：应用事件发布器，也可以通过AbstractApplicationContext的publish方法发布</li>
<li>ResourceLoaderAware：获取资源加载器，可以获取外部资源</li>
<li>ApplicationContextAware：获取上下文，包含了MessagerSource、EventPublisher、ResourceLoader</li>
</ul>
<pre><code>@Service
public class AwareService implements BeanNameAware, ResourceLoaderAware {
    String beanName;
    ResourceLoader resourceLoader;

    @Override
    public void setBeanName(String s) {
        this.beanName = s;
    }

    @Override
    public void setResourceLoader(ResourceLoader resourceLoader) {
        this.resourceLoader = resourceLoader;
    }

    public void outputInfo() {
        System.out.println(&quot;bean在容器中的名称是：&quot;+beanName);
        Resource resource = resourceLoader.getResource(&quot;classpath:aware/test.txt&quot;);
        try {
            System.out.println(&quot;资源文件的内容是：&quot;+IOUtils.toString(resource.getInputStream()));
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre><h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><ul>
<li>注解需要异步执行(多线程)的方法</li>
</ul>
<pre><code>@Service
@Async //注解表明该方法是一个异步方法,注解在类上则表示类中所有方法都是异步的.
public class AsyncTaskService {
    public void executeAsyncTask(Integer i) {
        System.out.println(&quot;执行异步任务：&quot; + i);
    }

    public void executeAsyncTaskPlus(Integer i) {
        System.out.println(&quot;执行异步任务+1：&quot; + (i + 1));
    }
}
</code></pre><ul>
<li>开启异步执行的方法,并定义异步执行器</li>
</ul>
<pre><code>@Configuration
@ComponentScan(&quot;demo.springboot.taskexecutor&quot;)
@EnableAsync //使用@EnableAsync开启异步任务,实现异步配置类返回一个基于线程池的执行器
public class ExecutorConfig implements AsyncConfigurer {
    //重写替换系统获取的执行器
    @Override
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();
        taskExecutor.setCorePoolSize(5);
        taskExecutor.setMaxPoolSize(10);
        taskExecutor.setQueueCapacity(25);
        taskExecutor.initialize();
        return taskExecutor;
    }

    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return null;
    }

    public static void main(String[] args){
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ExecutorConfig.class);
        AsyncTaskService asyncTaskService = context.getBean(AsyncTaskService.class);
        /**
         * 调用异步方法时,Spring会自动获取内部的Async执行器来执行
         * 执行的结果是异步的(通过多线程执行),而不是0-9顺序的执行
         */
        for (int i=0;i&lt;10;i++){
            asyncTaskService.executeAsyncTask(i);
            asyncTaskService.executeAsyncTaskPlus(i);
        }
        context.close();
    }
}
</code></pre><p><strong>结果展示</strong></p>
<pre><code>执行异步任务+1：1
执行异步任务：1
执行异步任务+1：2
执行异步任务：3
执行异步任务+1：3
执行异步任务：0
执行异步任务：2
执行异步任务：5
执行异步任务+1：5
执行异步任务：4
执行异步任务+1：4
执行异步任务：7
执行异步任务+1：7
执行异步任务：6
执行异步任务+1：6
执行异步任务：9
执行异步任务+1：9
执行异步任务：8
执行异步任务+1：8
执行异步任务+1：10
</code></pre><h2 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h2><p>现在使用注解就可以使用Spring的计划任务模块, 代替之前复杂繁琐的quartz整合</p>
<pre><code>@Service
public class SchedulerService {
    private static final SimpleDateFormat sdf = new SimpleDateFormat(&quot;HH:mm:ss&quot;);

    @Scheduled(fixedRate = 5000)
    public void reportCurrentTime(){System.out.println(&quot;每5秒执行,当前时间:&quot;+sdf.format(new Date()));}

    @Scheduled(cron = &quot;0 08 17 ? * *&quot;)
    public void fixedTimeExecution(){System.out.println(&quot;定时执行:&quot;+sdf.format(new Date()));}
}
</code></pre><pre><code>@Configuration
@ComponentScan(&quot;demo.springboot.taskscheduler&quot;)
@EnableScheduling //注解开启计划任务
public class SchedulerConfig {
    public static void main(String[] args){
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(SchedulerConfig.class);
    }
}
</code></pre><h2 id="条件注解"><a href="#条件注解" class="headerlink" title="条件注解"></a>条件注解</h2><p>根据条件操控Bean, 比profile更通用, 可以定义在程序内方便理解 <br></p>
<ul>
<li>设置条件, 实现条件实现的函数</li>
</ul>
<pre><code>public class WindowsCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        return context.getEnvironment().getProperty(&quot;os.name&quot;).contains(&quot;Windows&quot;);
    }
}

public class LinuxCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        return context.getEnvironment().getProperty(&quot;os.name&quot;).contains(&quot;Linux&quot;);
    }
}
</code></pre><ul>
<li>设置Bean的不同实现</li>
</ul>
<pre><code>public class WindowsServiceImpl implements ListService {
    @Override
    public String showListCmd() { return &quot;dir&quot;; }
}
public class LinuxServiceImpl implements ListService {
    @Override
    public String showListCmd() { return &quot;ls&quot;; }
}
</code></pre><ul>
<li>设置Bean的加载条件</li>
</ul>
<pre><code>@Configuration
public class ConditionalConfig {

    @Bean
    @Conditional(WindowsCondition.class)
    public ListService windowsList() { return new WindowsServiceImpl(); }

    @Bean
    @Conditional(LinuxCondition.class)
    public ListService linuxList() { return new LinuxServiceImpl(); }

    public static void main(String[] args) {
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ConditionalConfig.class);
        ListService listService = context.getBean(ListService.class);
        System.out.println(&quot;查看系统列表的命令是:&quot; + listService.showListCmd());
    }
}
</code></pre><h2 id="组合注解和元注解"><a href="#组合注解和元注解" class="headerlink" title="组合注解和元注解"></a>组合注解和元注解</h2><p>自定义注解组合常用的注解(类似 继承/组合)</p>
<pre><code>@Target(ElementType.TYPE)/* Class, interface (including annotation type), or enum declaration */
@Retention(RetentionPolicy.RUNTIME)/* 保留至运行时 ,运行时可以检测到这个注解 */
@Documented/* 被javadoc记录 */
 /* 组合注解类似继承 ,可以使用同名函数(属性) 覆盖 被组合的注解中的函数(属性) */
@Configuration
@ComponentScan
public @interface CommonConfiguration {
    String[] value() default {};
}
</code></pre><p>使用组合注解</p>
<pre><code>@CommonConfiguration(&quot;demo.springboot.annotation&quot;)
public class DemoConfig {
    //...
}
</code></pre><h2 id="Enable-注解的原理"><a href="#Enable-注解的原理" class="headerlink" title="@Enable*注解的原理"></a>@Enable*注解的原理</h2><p>常用的注解</p>
<pre><code>@org.springframework.context.annotation.EnableAspectJAutoProxy //aspectj支持
@org.springframework.scheduling.annotation.EnableAsync //开启异步方法
@org.springframework.web.servlet.config.annotation.EnableWebMvc //开启Mvc配置
@org.springframework.boot.context.properties.EnableConfigurationProperties //开启注解配置bean
@org.springframework.cache.annotation.EnableCaching //开启注解式缓存
@org.springframework.scheduling.annotation.EnableScheduling //开启计划任务

@EnableJpaRepositories //开启JPA支持
@org.springframework.transaction.annotation.EnableTransactionManagement //开启注解事务
</code></pre><p>原理解析 <br></p>
<ul>
<li>引入配置类@EnableScheduling</li>
</ul>
<pre><code>//注解
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Import(SchedulingConfiguration.class)/* 引入配置类 */
@Documented
public @interface EnableScheduling {

}

// 配置类 ,定义了一个bean(等效于 xml中的&lt;bean .../&gt;)
@Configuration
@Role(BeanDefinition.ROLE_INFRASTRUCTURE)
public class SchedulingConfiguration {
    @Bean(name = TaskManagementConfigUtils.SCHEDULED_ANNOTATION_PROCESSOR_BEAN_NAME)
    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)
    public ScheduledAnnotationBeanPostProcessor scheduledAnnotationProcessor() {
        return new ScheduledAnnotationBeanPostProcessor();
    }
}
</code></pre><ul>
<li>依据条件选择配置类@EnableAsync</li>
</ul>
<pre><code>@Import(AsyncConfigurationSelector.class)
public @interface EnableAsync {
    //...
}

//配置类
public class AsyncConfigurationSelector extends AdviceModeImportSelector&lt;EnableAsync&gt; {
    //...
    public String[] selectImports(AdviceMode adviceMode) {
        switch (adviceMode) {
            case PROXY:
                return new String[] { ProxyAsyncConfiguration.class.getName() };
            case ASPECTJ:
                return new String[] { ASYNC_EXECUTION_ASPECT_CONFIGURATION_CLASS_NAME };
            default:
                return null;
        }
    }
     //...
}
</code></pre><ul>
<li>动态注册Bean@EnableAspectJAutoProxy</li>
</ul>
<pre><code>@Import(AspectJAutoProxyRegistrar.class)
public @interface EnableAspectJAutoProxy {
    //...
}

class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar {

    @Override
    public void registerBeanDefinitions(
            AnnotationMetadata importingClassMetadata,  // 获取配置类的注解
            BeanDefinitionRegistry registry //注册bean
    ) {
        //...
        }
}
</code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><strong>手动导入<code>spring-test</code>或者<code>spring-boot-starter-test</code></strong></p>
<pre><code>@RunWith(SpringJUnit4ClassRunner.class) //包含需要启动的spring容器
@ContextConfiguration(classes = {DemoConfig.class}) //需要包含的配置

@ActiveProfiles(&quot;dev&quot;) //配合profile使用
public class DemoBeansIntegrationTests {
    @Autowired
    private DemoBean demoBean;

    @Test //测试用例
    public void contentTest() {
        String content = demoBean.getContent();
        Assert.assertEquals(content, &quot;register from dev&quot;);
    }
}
</code></pre>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span> PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span> UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
