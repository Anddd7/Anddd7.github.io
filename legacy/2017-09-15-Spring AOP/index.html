<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Spring AOP造成的@Controller注册失败 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/assets/avatar.jpeg" />
        </div>
        <div class="name">
            <i>Anddd7</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#主要对象"><span class="toc-text">主要对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#原因分析"><span class="toc-text">原因分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RequestMapping"><span class="toc-text">RequestMapping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结论"><span class="toc-text">结论</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Spring AOP造成的@Controller注册失败
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-01-06 21:20:16</span></span>
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>昨天在重构项目时 ,调整了原有Controller的路径 ,并抽取了部分方法形成AbstractController ,所有业务模块的Controller都继承它 .然后启动发现几乎所有移动过的Controller都失效了.</p>
<h2 id="主要对象"><a href="#主要对象" class="headerlink" title="主要对象"></a>主要对象</h2><ul>
<li>ControllerLogInterceptor : aop拦截器 ,拦截目标路径下所有Controller</li>
</ul>
<pre><code>@Pointcut(&quot;execution(public * com.eddy..*.*Controller.*(..))&quot;)
public void handleController() {
}
</code></pre><ul>
<li>AppController : 一个接口</li>
</ul>
<pre><code>public interface AppController {
    String getAppName();
}
</code></pre><ul>
<li>AbstractController : 抽象的Controller ,包含一些公用方法 ;实现了AppController接口</li>
</ul>
<pre><code>@Slf4j
public abstract class AbstractController implements AppController {
    @Autowired
    protected HttpSession session;

    @Override
    public String getAppName() {
        return OSC_APPNAME;
    }
}
</code></pre><ul>
<li>ContactController : 业务逻辑的Controller</li>
</ul>
<pre><code>@RestController
@RequestMapping(&quot;/eddy/contact&quot;)
public class ContactController extends AbstractOSCController {
...
}
</code></pre><h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p><li>因为是移动路径过后出现的 ,首先考虑路径影响  <br></li></p>
<p><ul>- 使用的SpringBoot ,全注解配置的Controller ,路径并不会影响Bean的解析</ul></p>
<ul>
<li>同路径下某一Controller可用 ,该Controller没有继承AbstractController ,继承了另一个类- 之前也是使用过继承Controller的做法 ,没有出现问题</li>
<li>这个类也在AOP的匹配范围内- AOP主要是代理原有Bean ,Abstract不会生成Spring Bean ,不会产生作用- 打印Debug Log : ContactController注册为Bean ,但没有扫描到mapping路径</li>
<li>断点查看Spring如何扫描Controller并添加mapping的<h2 id="RequestMapping"><a href="#RequestMapping" class="headerlink" title="RequestMapping"></a>RequestMapping</h2></li>
</ul>
<p>通过日志 ,找到扫描Mapping的目标类RequestMappingHandlerMapping (父对象AbstractHandlerMethodMapping#initHandlerMethods方法)</p>
<pre><code>//AbstractHandlerMethodMapping.class
protected void initHandlerMethods() {
        if (logger.isDebugEnabled()) {
            logger.debug(&quot;Looking for request mappings in application context: &quot; + getApplicationContext());
        }
        String[] beanNames = (this.detectHandlerMethodsInAncestorContexts ?
                BeanFactoryUtils.beanNamesForTypeIncludingAncestors(getApplicationContext(), Object.class) :
                getApplicationContext().getBeanNamesForType(Object.class));

        for (String beanName : beanNames) {
            if (!beanName.startsWith(SCOPED_TARGET_NAME_PREFIX)) {
                Class&lt;?&gt; beanType = null;
                try {
                    beanType = getApplicationContext().getType(beanName);
                }
                catch (Throwable ex) {
                    // An unresolvable bean type, probably from a lazy bean - let&#39;s ignore it.
                    if (logger.isDebugEnabled()) {
                        logger.debug(&quot;Could not resolve target class for bean with name &#39;&quot; + beanName + &quot;&#39;&quot;, ex);
                    }
                }
                if (beanType != null &amp;amp;&amp;amp; isHandler(beanType)) {
                    detectHandlerMethods(beanName);
                }
            }
        }
        handlerMethodsInitialized(getHandlerMethods());
    }
</code></pre><p>可以看到 ,通过循环已加载的Bean ,然后通过相应Handler (这里是RequestMappingHandler) 判断是否应该处理.</p>
<pre><code>//RequestMappingHandlerMapping.class
@Override
protected boolean isHandler(Class&lt;?&gt; beanType) {
    //判断对应class类是否 有Controller注解或继承自Controller注解 (RestController) 
        return (AnnotatedElementUtils.hasAnnotation(beanType, Controller.class) ||
                AnnotatedElementUtils.hasAnnotation(beanType, RequestMapping.class));
    }
</code></pre><p>这里断点调试后 ,发现ContactController直接跳过 ,它没有@Controller注解!!!! 但代码里确实进行了配置 ,在经过多次重编译过后 … 发现ContactController对应Bean的classType是 com.sun.Proxy…</p>
<p><strong>也就是说SpringAOP代理将这个Bean本有的信息抹除了 ,所以我修改了SpringAOP的匹配路径 ,果然Controller可用了.</strong></p>
<p>但是AOP部分的代码也很重要 ,我不希望丢掉.同时我发现  <br></p>
<ul>
<li>单一的Controller(无继承关系) 和 AOP 工作的很好 <br></li>
<li>继承自其他类的Controller也工作的很好 <br><br>那么 ,Spring的AOP应该是不会破坏Bean的类型判断的 : 他们的类型都是 <code>com.eddy.ContactController$Spring..Cglib...</code>这样的 ,是能够通过SpringMVC的检查的</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>最后的不同就在于那个简单的接口… <br></p>
<ul>
<li>Spring默认使用JDK ,对接口进行动态代理 : ContactController extends AbstractController implement AppController ,所以将与接口有关的类都代理成了Proxy . <br></li>
<li>而继承自单一类/没有接口的 ,使用cglib代理 ,就不存在这个问题 ,他依旧保留了原有class的信息.</li>
</ul>
<p>增加配置 spring.aop.proxy-target-class=true ,默认统一使用cglib即可</p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span> PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span> UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
