<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        数据分析 起步 (一) MongoDB+Hadoop - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/assets/avatar.jpeg" />
        </div>
        <div class="name">
            <i>Anddd7</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备"><span class="toc-text">准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#爬虫"><span class="toc-text">爬虫</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#完成程序"><span class="toc-text">完成程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MongoDB"><span class="toc-text">MongoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hadoop"><span class="toc-text">Hadoop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开始"><span class="toc-text">开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TaskManager任务管理器"><span class="toc-text">TaskManager任务管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Crawler抓取"><span class="toc-text">Crawler抓取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Analysis分析"><span class="toc-text">Analysis分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#异常"><span class="toc-text">异常</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结果"><span class="toc-text">结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后续"><span class="toc-text">后续</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        数据分析 起步 (一) MongoDB+Hadoop
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-01-06 21:20:16</span></span>
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>上个月看到一个学长在做斗鱼弹幕分析的开源项目 ,正好之前的计划已经完成了大半 ,所以决定借此机会学习一波爬虫和数据分析. 后面学长忙其他事去了 ,我也就开了一个新坑 ,从抓取分析B站的数据开始 :）</p>
<p>项目地址:<a href="https://github.com/Anddd7/bilibili-analysis-data" target="_blank" rel="noopener">bilibili-analysis-data</a></p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="爬虫"><a href="#爬虫" class="headerlink" title="爬虫"></a>爬虫</h3><p>说到爬虫 ,就会想到Python ,边学边写我就直接上手了 .因为之前有接触过scala ,最近工作中也会写很多js (前端还很菜) ,所以语法掌握起来还不算太难 .不过我也没有一开始就写爬虫 ,先写了一个上传文件到FTP的脚本 ,用来上传我工作中的一些文件.</p>
<blockquote>
</blockquote>
<p>主要是练手 ,所以使用python成功抓取数据并放入DB后 ,还是用Java重构了那部分代码 ,准备后期做自动化程序</p>
<h5 id="完成程序"><a href="#完成程序" class="headerlink" title="完成程序"></a>完成程序</h5><p><li>Python <br></li></p>
<p><ul>- 上传文件到FTP</ul></p>
<ul>
<li>爬取<a href="http://linux.linuxidc.com/" target="_blank" rel="noopener">Linux公社</a>的技术书籍</li>
<li>抓取bilibili视频数据 (开始抓的页面 ,后来发现了几个api接口 ,直接返回的JSON)- 使用<a href="https://github.com/code4craft/webmagic" target="_blank" rel="noopener">webmagic</a>抓取房天下的房屋数据 (代码已删除)</li>
<li>抓取bilibili接口数据<blockquote>
</blockquote>
Python的第三方功能非常完善和强大 ,也有脚本语言简洁/直接的特点 ,用起来还是很不错的 .<br>在最近的工作中 ,我用Python生成带版本号的js文件 ,扫描并替换html中的script和css相对地址 ,实现前端文件的版本系统.</li>
</ul>
<h3 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h3><p>中间对数据分析部分的技术选型犹豫了一阵 ,开始想使用mysql ,使用ORM框架 ,然后就可以操作POJO类进行后面的处理 .</p>
<p>但是关系型数据库对形态不固定的数据支持度很低 (抓取的数据五花八门 ,就算通过接口抓 ,也要建表建字段 ,心累)</p>
<p>所以果断使用了MongoDB ,抓取的数据直接insert进去就行 ,不用管字段的数量和类型.</p>
<p>建议用IDEA的朋友安装<a href="https://plugins.jetbrains.com/plugin/7141-mongo-plugin" target="_blank" rel="noopener">Mongo Plugin</a> ,启动mongod.exe后就可以在IDEA中查看数据了.</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170928142941455?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTg1ODQwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""></p>
<h3 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a>Hadoop</h3><p>(大)数据分析 ,自然少不了Hadoop/Spark等 ,Java环境下自然首选Hadoop .学习的话最好搭建一个开发环境 ,不然每次都要把数据传到服务器上也是很麻烦的一件事 .</p>
<p><a href="http://blog.csdn.net/antgan/article/details/52067441" target="_blank" rel="noopener">教你Windows平台安装配置Hadoop</a>选用Hadoop 2.7.4 + <a href="https://github.com/sardetushar/hadooponwindows" target="_blank" rel="noopener">hadooponwindows</a> 就可以在Windows上单机运行Hadoop程序了 .</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><blockquote>
</blockquote>
<p></p><p>自我提醒: <br><br>   在搭建这个项目的时候 ,我就想要构造一个灵活的系统/要抽取/要继承/要抽象 ,反而把代码弄得很乱 ,结构很散 . </p><br>在工作的时候(目前由我独立开发) ,因为有很强的目的性 ,我会优先完成功能 ,然后再考虑功能是否重复/可否抽象 .<p></p>
<h3 id="TaskManager任务管理器"><a href="#TaskManager任务管理器" class="headerlink" title="TaskManager任务管理器"></a>TaskManager任务管理器</h3><p>分发任务</p>
<pre><code>public void router(String module, String taskName, List&lt;Object&gt; params) {
        switch (module) {
            case &quot;crawler&quot;:
                routerCrawler(taskName, params);
                break;
            case &quot;analysis&quot;:
                routerAnalysis(taskName, params);
                break;
        }
    }

    public void routerCrawler(String taskName, List&lt;Object&gt; params) {
      ...
    }

    public void routerAnalysis(String taskName, List&lt;Object&gt; params) {
      ...
    }
</code></pre><p>执行任务并记录任务的状态</p>
<pre><code>public void execute(String module, String taskName, List&lt;Object&gt; params) {
        BasicDBObject searchQuery = new BasicDBObject()
                .append(&quot;module&quot;, module)
                .append(&quot;taskName&quot;, taskName)
                .append(&quot;params&quot;, params);

        log.debug(&quot;开始执行任务:\n{}&quot;, searchQuery.toString());

        try (MongoCursor&lt;Document&gt; result = MongodbDao.find(TASK_RECORD, searchQuery)) {
            if (result.hasNext()) {
                Document taskRecord = result.next();

                log.debug(&quot;查询到任务历史记录:\n{}&quot;, taskRecord.toString());

                TaskStatusEnum taskStatus = TaskStatusEnum.valueOf(taskRecord.getString(&quot;taskStatus&quot;));
                if (taskStatus.equals(running)) {
                    throw new KnownException(taskRecord.toString() + &quot;任务正在执行中 ,请勿重复执行&quot;);
                } else if (taskStatus.equals(TaskStatusEnum.finished)) {
                    throw new KnownException(taskRecord.toString() + &quot;任务已执行完毕 ,请到结果页面进行查看&quot;);
                }
            }
        }

        Instant start = now();
        searchQuery.append(&quot;taskStatus&quot;, running);
        searchQuery.append(&quot;startTime&quot;, start);
        MongodbDao.insert(TASK_RECORD, searchQuery);

        executorService.execute(() -&gt; {
            TaskStatusEnum endStatus = finished;
            try {
                router(module, taskName, params);
            } catch (Exception e) {
                endStatus = stop;
                log.error(&quot;{}任务执行异常中止&quot;, String.join(module, taskName), e);
            }

            log.debug(&quot;{}任务执行完毕: {} ms&quot;, String.join(module, taskName), Duration.between(start, now()).toMillis());
            MongodbDao.update(TASK_RECORD, searchQuery,
                    new BasicDBObject()
                            .append(&quot;$set&quot;, new BasicDBObject()
                                    .append(&quot;taskStatus&quot;, endStatus)
                                    .append(&quot;endTime&quot;, now())));
        });
    }
</code></pre><p>任务管理器是单例的 ,并运行在主线程 ,因此能够保证execute方法是线程安全的 ; 确定执行的任务由子线程执行 ,并且将状态保存在DB中 ,可以随时检查执行状态.</p>
<h3 id="Crawler抓取"><a href="#Crawler抓取" class="headerlink" title="Crawler抓取"></a>Crawler抓取</h3><p>多种渠道抓取数据 (这里是使用的bilibili开放的一个search接口)</p>
<pre><code>public void search(int year, int month) {
        String out = source_search.table(getYYYYMM(year, month));
        MongodbDao.drop(out);

        ExecutorService fixedThreadPool = Executors.newFixedThreadPool(5);
        for (Integer cateId : CategoryMap.getCategoryIds()) {
            fixedThreadPool.execute(() -&gt; {
                SearchRequest request = new SearchRequest(cateId, year, month);
                while (request.hasNext()) {
                    try {
                        MongodbDao.insert(out, request.next().getResult());
                    } catch (Exception e) {
                        log.error(&quot;获取数据失败:&quot; + request.getLongURL(), e);
                    }
                }
                log.info(&quot;{}的视频已处理完成&quot;, getCategoryName(cateId));
            });
        }
        fixedThreadPool.shutdown();

        try {
            fixedThreadPool.awaitTermination(Long.MAX_VALUE, TimeUnit.MINUTES);
            log.info(&quot;{}-{}视频数据已全部插入到{}&quot;, year, month, out);
        } catch (InterruptedException e) {
            log.error(&quot;&quot;, e);
        }
    }
</code></pre><p>把search接口封装成一个请求类 ,并提供便捷的访问方法</p>
<pre><code>public class SearchRequest {
    public static final String API_URL = &quot;https://s.search.bilibili.com/cate/search&quot;;

    public static final String ORDER_CLICK = &quot;click&quot;;// 点击
    public static final String ORDER_STOW = &quot;stow&quot;;// 收藏
    public static final String ORDER_SCORES = &quot;scores&quot;;// 评分
    public static final String ORDER_DM = &quot;dm&quot;;// 弹幕
    public static final String ORDER_COIN = &quot;coin&quot;;// 硬币

    public static final Integer COPYRIGHT_ALL = -1;// 全部
    public static final Integer COPYRIGHT_OWN = 1;// 原创

    final String main_ver = &quot;v3&quot;;
    final String search_type = &quot;video&quot;;
    String view_type = &quot;hot_rank&quot;;
    final String pic_size = &quot;160x100&quot;;

    String order = ORDER_CLICK;
    Integer copy_right = COPYRIGHT_ALL;

    Integer page = 0;
    Integer pagesize = 100;

    Integer cate_id;
    String time_from;
    String time_to;

    private Boolean nextFlag = true;
    @Getter
    private String longURL;

  /*---------------------------------------------------------------------------------*/

    public SearchRequest(Integer cate_id, String time_from, String time_to) {
        this.cate_id = cate_id;
        this.time_from = time_from;
        this.time_to = time_to;
    }

    public SearchRequest(Integer cate_id, Integer year, Integer month) {
        String[] dateRange = DateTools.getDateRangeYYYYMMDD(year, month);
        this.cate_id = cate_id;
        this.time_from = dateRange[0];
        this.time_to = dateRange[1];
    }

  /*---------------------------------------------------------------------------------*/

    public Boolean hasNext() {
        return nextFlag;
    }

    public SearchResponse next() throws IOException {
        SearchResponse res = get(this.page + 1);
        if (res.numPages == 0 || res.numPages.equals(page)) {
            nextFlag = false;
        }
        return res;
    }

    public SearchResponse get(Integer page) throws IOException {
        if (page &lt; 1) {
            throw new KnownException(&quot;page must &gt; 0&quot;);
        }
        this.page = page;
        return response(get());
    }

    private String get() throws IOException {
        longURL = API_URL + &quot;?&quot; + getParam4URL();
        return HttpTools.getInstance().get(longURL);
    }

    private String getParam4URL() {
        return new StringBuilder()
                .append(&quot;main_ver&quot;).append(&quot;=&quot;).append(main_ver).append(&quot;&amp;amp;&quot;)
                .append(&quot;search_type&quot;).append(&quot;=&quot;).append(search_type).append(&quot;&amp;amp;&quot;)
                .append(&quot;view_type&quot;).append(&quot;=&quot;).append(view_type).append(&quot;&amp;amp;&quot;)
                .append(&quot;pic_size&quot;).append(&quot;=&quot;).append(pic_size).append(&quot;&amp;amp;&quot;)
                .append(&quot;order&quot;).append(&quot;=&quot;).append(order).append(&quot;&amp;amp;&quot;)
                .append(&quot;copy_right&quot;).append(&quot;=&quot;).append(copy_right).append(&quot;&amp;amp;&quot;)
                .append(&quot;cate_id&quot;).append(&quot;=&quot;).append(cate_id).append(&quot;&amp;amp;&quot;)
                .append(&quot;page&quot;).append(&quot;=&quot;).append(page).append(&quot;&amp;amp;&quot;)
                .append(&quot;pagesize&quot;).append(&quot;=&quot;).append(pagesize).append(&quot;&amp;amp;&quot;)
                .append(&quot;time_from&quot;).append(&quot;=&quot;).append(time_from).append(&quot;&amp;amp;&quot;)
                .append(&quot;time_to&quot;).append(&quot;=&quot;).append(time_to)
                .toString();
    }

    private SearchResponse response(String json) {
        SearchResponse searchResponse = JSON.parseObject(json, SearchResponse.class);
        if (searchResponse.code != 0) {
            throw new KnownException(&quot;返回Code错误:&quot; + searchResponse.code);
        }
        searchResponse.setJson(json);
        searchResponse.getResult().forEach(map -&gt; map.put(&quot;cateid&quot;, cate_id));
        return searchResponse;
    }
}
</code></pre><p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170928144825361?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTg1ODQwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""></p>
<h3 id="Analysis分析"><a href="#Analysis分析" class="headerlink" title="Analysis分析"></a>Analysis分析</h3><p>使用hadoop任务分析视频的tag出现频率</p>
<pre><code>@Slf4j
public class TagSplit extends AbstractMongoAnalysis {

    @Override
    public void configMapperReducer(HadoopJobBuilder builder) throws IOException {
        builder.addMapper(SpliterMapper.class)
                .setReducer(TextSumReducer.class);
    }

    public static class SpliterMapper extends Mapper&lt;Object, BSONObject, Text, IntWritable&gt; {

        private static final IntWritable one = new IntWritable(1);
        private Text word = new Text();

        @Override
        public void map(Object key, BSONObject value, Context context)
                throws IOException, InterruptedException {
            String tags = (String) value.get(&quot;tag&quot;);
            for (String s : tags.split(&quot;,&quot;)) {
                word.set(s);
                context.write(word, one);
            }
        }
    }
}
</code></pre><p>Analysis任务类中主要是对Map/Reduce类进行定义和添加 ;将其他操作都封装在了AbstractMongoAnalysis中 ,包括设置input/output format</p>
<pre><code>@Slf4j
public abstract class AbstractMongoAnalysis {
    /**
     * 任务实现类配置Mapper和Reducer的入口
     */
    abstract public void configMapperReducer(HadoopJobBuilder builder) throws IOException;

    /**
     * 获取in/out集合 ,根据analysis的配置执行一系列操作
     */
    public void execute(String in, String out) {
        Preconditions.checkNotNull(in, out);
        MongodbDao.drop(out);//删除之前的结果表
        try {
            HadoopJobBuilder builder = new HadoopJobBuilder();
            builder.config(mongoConfig(in, out), JobEnum.mongodb);//自动注入mongo+hadoop相关配置
            configMapperReducer(builder);//注入mapper/reducer
            builder.build().waitForCompletion(true);//运行
        } catch (IOException e) {
            log.error(&quot;&quot;, e);
            throw new KnownException(&quot;任务创建失败:&quot;, e);
        } catch (Exception e) {
            log.error(&quot;&quot;, e);
            throw new KnownException(&quot;任务执行失败:&quot;, e);
        }
    }
}
</code></pre><p>HadoopJobBuilder是我写的一个Buider类 ,方便配置</p>
<pre><code>@Slf4j
public class HadoopJobBuilder {

    private Job job;//hadoop任务
    private Configuration conf;//当前任务的配置

    public HadoopJobBuilder config(Configuration conf, JobEnum jobEnum) throws IOException {
        this.conf = conf;
        this.job = getInstance(conf, jobEnum.name());
        job.setJarByClass(this.getClass());
        switch (jobEnum) {
            case mongodb:
                return initMongo();
            default:
                return this;
        }
    }

    //如果是mongodb
    private HadoopJobBuilder initMongo() throws IOException {
        job.setInputFormatClass(MongoInputFormat.class);
        job.setOutputFormatClass(MongoOutputFormat.class);
        return this;
    }

    public HadoopJobBuilder addMapper(Class&lt;? extends Mapper&gt; mapperClass) throws IOException {
        HadoopTools.addMapper(job, mapperClass, conf);
        return this;
    }

    public HadoopJobBuilder setReducer(Class&lt;? extends Reducer&gt; reducerClass) {
        HadoopTools.setReducer(job, reducerClass, conf);
        //job.setCombinerClass(reducerClass);
        return this;
    }

    public HadoopJobBuilder afterReducer(Class&lt;? extends Mapper&gt; mapperClass) throws IOException {
        HadoopTools.afterReducer(job, mapperClass, conf);
        return this;
    }

    public Job build() {
        return job;
    }
}
</code></pre><h4 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h4><p>如果出现<code>IOException in org.apache.hadoop.io.nativeio.NativeIO access(String path, AccessRight desiredAccess)</code> ,应该是hadoop在Windows环境下操作文件的权限不通过 , 可以把NativeIO .java复制出来(同路径) ,修改这一段代码然后运行即可 (会自动覆盖hadoop包中的class)</p>
<pre><code>public static boolean access(String path, AccessRight desiredAccess)
                throws IOException {
            //return access0(path, desiredAccess.accessRight());
            return true;
        }
</code></pre><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>数据分析才刚刚开始 .(游戏占据半壁江山啊 : ) <br><br><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170928150542071?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTg1ODQwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""></p>
<p>不过作为一个程序猿 ,做数据分析的瓶颈更多在主题上 ,’我应该分析啥”这些数据能得出啥”我的数据有什么意义’,代码只需要逻辑表达而已 .</p>
<h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><ul>
<li>更多的分析</li>
<li>图形化展示</li>
<li>更多数据</li>
<li>Hadoop的其他组件</li>
</ul>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span> PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span> UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
