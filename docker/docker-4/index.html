<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        （四）多主机部署和服务发现 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/assets/avatar.jpeg" />
        </div>
        <div class="name">
            <i>Anddd7</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#多主机部署与服务发现"><span class="toc-text">多主机部署与服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#动态服务发现"><span class="toc-text">动态服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Consul"><span class="toc-text">Consul</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#练习"><span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Registrator"><span class="toc-text">Registrator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多主机部署"><span class="toc-text">多主机部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DOCKER-SWARM"><span class="toc-text">DOCKER SWARM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SWARM-调度策略"><span class="toc-text">SWARM - 调度策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SWARM-FILTER-选项"><span class="toc-text">SWARM - FILTER 选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Swarm-中缺少了什么功能？"><span class="toc-text">Swarm 中缺少了什么功能？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他集群管理方案…"><span class="toc-text">其他集群管理方案…</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#监控-管理-追踪"><span class="toc-text">监控/管理/追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DOCKER日志"><span class="toc-text">DOCKER日志</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        （四）多主机部署和服务发现
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-08-10 00:00:00</span></span>
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="多主机部署与服务发现"><a href="#多主机部署与服务发现" class="headerlink" title="多主机部署与服务发现"></a><strong>多主机部署与服务发现</strong></h1><p>多主机部署时主要考虑的就是如何让不同主机上的容器可以通过网络访问。一是要知道主机的位置 - 服务发现，二是协调容器的相互访问。</p>
<p>比如，最简单的方式是我已知主机的IP地址，然后设置容器与主机的端口转发，我就可以在容器中通过<a href="HostIP:ContainerForwardPort" target="_blank" rel="noopener">HostIP:ContainerForwardPort</a>进行访问。</p>
<p>当然实际应用中我们需要更灵活的方式，比如动态的服务发现 - 获取指定服务所在的容器地址和连接方式，集中化管理、监控、日志记录等操作。</p>
<h2 id="动态服务发现"><a href="#动态服务发现" class="headerlink" title="动态服务发现"></a>动态服务发现</h2><p>客户端/服务端是如何确定其他服务的 IP 地址/端口？由于服务会根据需求动态伸缩，会导致静态配置不起作用</p>
<ul>
<li>两大方面：<ul>
<li>服务注册</li>
<li>服务查询</li>
</ul>
</li>
<li>随之而来的其他挑战：健康检查、监控、负载均衡</li>
</ul>
<h3 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h3><p> Consul 是一个分布式高可用的服务发现和配置的工具, 查询服务提供了 HTTP REST API 和 DNS interfaces, 通过 REST API 进行更新</p>
<ul>
<li><a href="https://www.jianshu.com/p/f8746b81d65d" target="_blank" rel="noopener">Consul教程</a></li>
<li>由m个server和n个client组成<ul>
<li>server会持久化信息, client只接收和转发信息</li>
<li>每个主机(数据中心)上可以有多个server和client</li>
<li>每一个数据中心有且只有一个server-leader</li>
</ul>
</li>
</ul>
<p><img src="/images/docker-consul.png" alt=""></p>
<h4 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h4><pre><code class="bash"># 启动consul server作为node1
docker run -d \
-e &#39;CONSUL_LOCAL_CONFIG={&quot;skip_leave_on_interrupt&quot;: true}&#39; \
--name=node1 consul \
agent -server -bind=172.17.0.2  -bootstrap-expect=3 -node=node1 # consul CLI 参数
</code></pre>
<ul>
<li>node：节点的名称</li>
<li>bind：绑定的一个地址，用于节点之间通信的地址，可以是内外网，必须是可以访问到的地址</li>
<li>server：这个就是表示这个节点是个SERVER</li>
<li>bootstrap-expect：这个就是表示期望提供的SERVER节点数目，数目一达到，它就会被激活，然后就是LEADER了</li>
</ul>
<pre><code class="bash"># 启动其他server节点
docker run -d -e &#39;CONSUL_LOCAL_CONFIG={&quot;skip_leave_on_interrupt&quot;: true}&#39; --name=node2 consul agent -server -bind=172.17.0.3  -join=172.17.0.2 -node-id=$(uuidgen | awk &#39;{print tolower($0)}&#39;)  -node=node2
docker run -d -e &#39;CONSUL_LOCAL_CONFIG={&quot;skip_leave_on_interrupt&quot;: true}&#39; --name=node3 consul agent -server -bind=172.17.0.4  -join=172.17.0.2 -node-id=$(uuidgen | awk &#39;{print tolower($0)}&#39;)  -node=node3 -client=172.17.0.4
# 启动client节点
docker run -d -e &#39;CONSUL_LOCAL_CONFIG={&quot;leave_on_terminate&quot;: true}&#39; --name=node4 consul agent -bind=172.17.0.5 -retry-join=172.17.0.2 -node-id=$(uuidgen | awk &#39;{print tolower($0)}&#39;)
</code></pre>
<ul>
<li>join：这个表示启动的时候，要加入到哪个集群内，这里就是说要加入到node-1的集群</li>
<li>node-id：这个貌似版本8才加入的，这里用这个来指定唯一的节点ID</li>
<li>client：这个表示注册或者查询等一系列客户端对它操作的IP，如果不指定这个IP，默认是127.0.0.1。</li>
</ul>
<pre><code class="bash"># 查询集群配置
CNadliao:~ adliao$ docker exec -t node1 consul members
Node          Address          Status  Type    Build  Protocol  DC   Segment
node1         172.17.0.2:8301  alive   server  1.2.1  2         dc1  &lt;all&gt;
node2         172.17.0.3:8301  alive   server  1.2.1  2         dc1  &lt;all&gt;
node3         172.17.0.4:8301  alive   server  1.2.1  2         dc1  &lt;all&gt;
588d5e0a42ef  172.17.0.5:8301  alive   client  1.2.1  2         dc1  &lt;default&gt;
# 查询当前leader
CNadliao:~ adliao$ docker exec -t node2 curl http://172.17.0.4:8500/v1/status/leader
&quot;172.17.0.4:8300&quot;
</code></pre>
<pre><code class="bash"># 将consul的端口映射到主机上
docker run -d -p 8500:8500 -h server-node --name server-node consul agent -server -bootstrap-expect=1 -node=server-node -client=0.0.0.0 -ui -datacenter=dc2
# 获取server的内网地址
JOIN_IP=$(docker inspect -f &#39;{{.NetworkSettings.IPAddress}}&#39; server-node) # 172.17.0.6
# 启动client
docker run -d -p 8600:8600 -p 18500:8500 -p 8600:53/udp --name client-node -h client-node consul agent -node=client-node -join=172.17.0.6 -datacenter=dc2

# 查看
docker exec -t server-node consul members
docker exec -t client-node curl http://172.17.0.6:8500/v1/status/leader

curl http://localhost:8500/v1/status/leader
curl http://localhost:18500/v1/status/leader

http://localhost:8500/ui
</code></pre>
<h3 id="Registrator"><a href="#Registrator" class="headerlink" title="Registrator"></a>Registrator</h3><p><a href="https://github.com/gliderlabs/registrator" target="_blank" rel="noopener">Registrator</a> 是一个为Docker设计的服务注册工具, 可以自动注册服务，且不需要通过增加代码来与 Consul REST API 通信</p>
<pre><code class="bash"># 启动registrator
docker run -d \
    --name=registrator \
    --net=host \
    --volume=/var/run/docker.sock:/tmp/docker.sock \
    gliderlabs/registrator:latest \
      consul://172.17.0.6:8500
# 查看服务(前面已映射8500到本机)
http://localhost:8500/v1/catalog/services/
http://localhost:8500/ui
# 启动其他服务(需要开放端口)
docker run -d -it --name service1 -p 5000 busybox
</code></pre>
<h2 id="多主机部署"><a href="#多主机部署" class="headerlink" title="多主机部署"></a>多主机部署</h2><p>在生产环境中，我们需要多台主机运行应用程序和服务 </p>
<p>目标:</p>
<ul>
<li>减少系统中的单点故障</li>
<li>提高应用程序和服务的可用性</li>
<li>能够对应用程序和服务进行横向扩展</li>
</ul>
<p>实现方式:</p>
<ul>
<li>在每个应用程序/服务的负载均衡器后运行多个实例</li>
<li>通过多主机分布实例</li>
</ul>
<h3 id="DOCKER-SWARM"><a href="#DOCKER-SWARM" class="headerlink" title="DOCKER SWARM"></a><em>DOCKER SWARM</em></h3><p>Docker Swarm 解决方案的主要优势：</p>
<ul>
<li>Docker 的默认集群方案</li>
<li>将 Docker 主机池抽象为一个单一、虚拟的主机</li>
<li>提供统一的 Docker API - 意味着可以使用已有工具，比如: docker command-line/compose</li>
<li>允许跨整个集群的持久化存储管理</li>
<li>是一站式的解决方案，允许替换更强大的后端</li>
<li>很早已经发布了产品环境版本，不再只是 Beta 版本 :)</li>
</ul>
<p>Swarm Manager – Discovery Service -&gt; n x Swarn Node</p>
<h4 id="SWARM-调度策略"><a href="#SWARM-调度策略" class="headerlink" title="SWARM - 调度策略"></a>SWARM - 调度策略</h4><ul>
<li>Binpack - 选择运行容器最集中的节点运行新容器</li>
<li>Spread - 选择运行容器最少的节点运行新容器</li>
<li>Random - 随机选择节点运行新容器</li>
</ul>
<h4 id="SWARM-FILTER-选项"><a href="#SWARM-FILTER-选项" class="headerlink" title="SWARM - FILTER 选项"></a>SWARM - FILTER 选项</h4><ul>
<li>Constraint - 通过约束标签选择节点</li>
<li>Affinity - 通过已有容器或镜像名选择节点</li>
<li>Port - 通过特定的端口选择节点</li>
<li>Dependency - 通过依赖来选择节点</li>
<li>Health - 通过健康状况来选择节点</li>
</ul>
<h4 id="Swarm-中缺少了什么功能？"><a href="#Swarm-中缺少了什么功能？" class="headerlink" title="Swarm 中缺少了什么功能？"></a>Swarm 中缺少了什么功能？</h4><ul>
<li>没有期望的状态扩展</li>
<li>不支持健康检查(Healthcheck)</li>
<li>不支持自动修复(autoheal)</li>
<li>不支持负载均衡器</li>
<li>Swarm功能太欠缺</li>
</ul>
<h4 id="其他集群管理方案…"><a href="#其他集群管理方案…" class="headerlink" title="其他集群管理方案…"></a>其他集群管理方案…</h4><ul>
<li>Swarm Mode: 新方案，使用 Swarmkit 核心库</li>
<li>Swarmkit: 开源项目，单独构建与运行</li>
<li>Kubernetes : 功能全，比较重型</li>
<li>Mesos : Twitter 风格, 与 Swarm 保持一致</li>
<li>Fleet : CoreOS 风格, 简单, 功能不多</li>
<li>Deis : Heroku 风格, 工作流方式</li>
</ul>
<h1 id="监控-管理-追踪"><a href="#监控-管理-追踪" class="headerlink" title="监控/管理/追踪"></a>监控/管理/追踪</h1><ul>
<li>集中式日志聚合以及如何使用日志帮助管理多台宿主机上的容器</li>
<li>使用关系ID追踪跨服务调用问题</li>
<li>应用和服务的监控和指标收集</li>
<li>使用可视化面板让我们一窥系统全貌</li>
</ul>
<h3 id="DOCKER日志"><a href="#DOCKER日志" class="headerlink" title="DOCKER日志"></a>DOCKER日志</h3><ul>
<li>Docker有一套内建的机制来处理容器日志<br>可用的 logging drivers 包括: json-file (默认), syslog, journald, gelf, fluentd, awslogs, splunk(*)</li>
<li>查看某一个具体的容器的日志可以使用docker logs 命令:<ul>
<li>$ DOCKER_HOST=[docker_host|swarm_master] docker logs [container_name]</li>
</ul>
</li>
<li>Docker Compose可以一次性查看所有容器的日志:<ul>
<li>$ DOCKER_HOST=[docker_host|swarm_master] docker-compose logs</li>
</ul>
</li>
</ul>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span> PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span> UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
