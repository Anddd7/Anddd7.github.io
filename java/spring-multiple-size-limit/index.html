<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Anddd7"><title>Spring Exception:multiple-size-limit · Anddd7's Planet</title><meta name="description" content="spring.servlet.multipart.resolve-lazilyresolve-lazily = false (default)1234567891011121314org.springframework.web.multipart.MaxUploadSizeExceededExcep"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/foundation-icons.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/assets/avatar.jpeg" style="width:127px;"><h3 title=""><a href="/">Anddd7's Planet</a></h3><div class="description"><p>Level Up! Programmer~</p></div></div></div><ul class="social-links"><li><a href="http://github.com/Anddd7"><i class="fa fa-github"></i></a></li><li><a href="mailto:liaoad_space@sina.com"><i class="fi-mail"></i></a></li></ul><div class="footer"><span>Theme based on </span><a href="https://github.com/Ben02/hexo-theme-Anatole"> <strong>Anatole</strong></a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/assets/avatar.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Spring Exception:multiple-size-limit</a></h3></div><div class="post-content"><h2 id="spring-servlet-multipart-resolve-lazily"><a href="#spring-servlet-multipart-resolve-lazily" class="headerlink" title="spring.servlet.multipart.resolve-lazily"></a>spring.servlet.multipart.resolve-lazily</h2><h3 id="resolve-lazily-false-default"><a href="#resolve-lazily-false-default" class="headerlink" title="resolve-lazily = false (default)"></a>resolve-lazily = false (default)</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.multipart.<span class="string">MaxUploadSizeExceededException:</span> Maximum upload size exceeded; nested exception is java.lang.<span class="string">IllegalStateException:</span> org.apache.tomcat.util.http.fileupload.<span class="string">FileUploadBase$SizeLimitExceededException:</span> the request was rejected because its size (<span class="number">11534549</span>) exceeds the configured maximum (<span class="number">11534336</span>)</span><br><span class="line">at org.springframework.web.multipart.support.StandardMultipartHttpServletRequest.handleParseFailure(StandardMultipartHttpServletRequest.<span class="string">java:</span><span class="number">120</span>)</span><br><span class="line">at org.springframework.web.multipart.support.StandardMultipartHttpServletRequest.parseRequest(StandardMultipartHttpServletRequest.<span class="string">java:</span><span class="number">113</span>)</span><br><span class="line">at org.springframework.web.multipart.support.StandardMultipartHttpServletRequest.&lt;init&gt;(StandardMultipartHttpServletRequest.<span class="string">java:</span><span class="number">86</span>)</span><br><span class="line">at org.springframework.web.multipart.support.StandardServletMultipartResolver.resolveMultipart(StandardServletMultipartResolver.<span class="string">java:</span><span class="number">91</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// check multipart in dispatcher</span></span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.checkMultipart(DispatcherServlet.<span class="string">java:</span><span class="number">1128</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// dispatcher</span></span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.<span class="string">java:</span><span class="number">960</span>)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.<span class="string">java:</span><span class="number">925</span>)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.<span class="string">java:</span><span class="number">974</span>)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.<span class="string">java:</span><span class="number">877</span>)</span><br></pre></td></tr></table></figure>
<h3 id="resolve-lazily-true"><a href="#resolve-lazily-true" class="headerlink" title="resolve-lazily = true"></a>resolve-lazily = true</h3><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.multipart.MaxUploadSizeExceededException: Maximum upload size exceeded; nested exception <span class="built_in">is</span> java.lang.IllegalStateException: org.apache.tomcat.util.http.fileupload.FileUploadBase$SizeLimitExceededException: the request was rejected because its size (<span class="number">11534549</span>) exceeds the configured maximum (<span class="number">11534336</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest.handleParseFailure(StandardMultipartHttpServletRequest.java:<span class="number">120</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest.parseRequest(StandardMultipartHttpServletRequest.java:<span class="number">113</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest.initializeMultipart(StandardMultipartHttpServletRequest.java:<span class="number">127</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.multipart.support.AbstractMultipartHttpServletRequest.getMultipartFiles(AbstractMultipartHttpServletRequest.java:<span class="number">140</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.multipart.support.AbstractMultipartHttpServletRequest.getFiles(AbstractMultipartHttpServletRequest.java:<span class="number">92</span>)</span><br><span class="line"></span><br><span class="line">// spring request param resolve</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.<span class="built_in">method</span>.annotation.RequestParamMethodArgumentResolver.resolveName(RequestParamMethodArgumentResolver.java:<span class="number">175</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.<span class="built_in">method</span>.annotation.AbstractNamedValueMethodArgumentResolver.resolveArgument(AbstractNamedValueMethodArgumentResolver.java:<span class="number">106</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.<span class="built_in">method</span>.support.HandlerMethodArgumentResolverComposite.resolveArgument(HandlerMethodArgumentResolverComposite.java:<span class="number">124</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.<span class="built_in">method</span>.support.InvocableHandlerMethod.getMethodArgumentValues(InvocableHandlerMethod.java:<span class="number">161</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.<span class="built_in">method</span>.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">131</span>)</span><br><span class="line"></span><br><span class="line">// spring mvc handle</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.mvc.<span class="built_in">method</span>.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">102</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.mvc.<span class="built_in">method</span>.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">891</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.mvc.<span class="built_in">method</span>.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">797</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.mvc.<span class="built_in">method</span>.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line"></span><br><span class="line">// dispatcher</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">991</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">925</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">974</span>)</span><br><span class="line"><span class="built_in">at</span> org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:<span class="number">877</span>)</span><br></pre></td></tr></table></figure>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h5 id="Multipart解析流程"><a href="#Multipart解析流程" class="headerlink" title="Multipart解析流程"></a>Multipart解析流程</h5><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DispathcerServlet:960</span></span><br><span class="line">processedRequest = checkMultipart<span class="comment">(request)</span>;</span><br></pre></td></tr></table></figure>
<p>DispathcerServlet会检查request是否包含Multipart</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DispathcerServlet:1128</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.multipartResolver.resolveMultipart(request);</span><br><span class="line"></span><br><span class="line"><span class="comment">// StandardServletMultipartResolver:91</span></span><br><span class="line"><span class="keyword">return</span> new StandardMultipartHttpServletRequest(request, <span class="keyword">this</span>.resolveLazily);</span><br></pre></td></tr></table></figure>
<p>将request转型为StandardMultipartHttpServletRequest</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StandardServletMultipartResolver:85</span></span><br><span class="line"><span class="keyword">if</span> <span class="comment">(!lazyParsing)</span> &#123;</span><br><span class="line">    parseRequest<span class="comment">(request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果resolve-lazily=false会立即开始解析request</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RequestFacade:1084</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> request.<span class="title">getParts</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// Request:2811</span></span><br><span class="line">parseParts(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>解析part的时候就会去校验各种参数, 失败会返回异常</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request:2826</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> parseParts(<span class="keyword">boolean</span> <span class="keyword">explicit</span>)</span><br></pre></td></tr></table></figure>
<p>但实际上, tomcat的servlet在获取到multipart类型参数后就会自动解析, 将异常保存在request内部, 所以当spring再次调用parseParts时是直接获取的异常信息</p>
<h5 id="抛出异常的时机"><a href="#抛出异常的时机" class="headerlink" title="抛出异常的时机"></a>抛出异常的时机</h5><ul>
<li>可以发现上传文件并且lazily=false时, 出现异常会直接从dispatch的checkMultipart阶段就退出.</li>
<li>而lazily会等到spring mvc接受到dispatch过来的request, 开始注入parameter的时候才会第一次访问和parse multipart类型的参数.</li>
<li>因此第一种异常还没有进入mvc的范围, 因此CORS/formatter等配置都不会在此时生效; 而第二种是在注入参数的时候发生的, 约等于controller中抛出的异常, 会穿过完整的filters</li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-12-18</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://anddd7.github.io/java/spring-multiple-size-limit/,Anddd7's Planet,Spring Exception:multiple-size-limit,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/k8s/kubernetes-1/" title="（一）Kubernetes入门">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>